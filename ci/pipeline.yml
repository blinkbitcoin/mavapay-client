#@ load("@ytt:data", "data")
#@ load("@ytt:assert", "assert")

#@ load("vendor/pipeline-fragments.lib.yml",
#@   "repo_resource",
#@   "nodejs_audit",
#@   "nodejs_deps_resource",
#@   "pipeline_tasks_resource",
#@   "deps_version_resource",
#@   "bundled_deps_resource",
#@   "release_task_image_config",
#@   "nodejs_task_image_config",
#@   "slack_resource",
#@   "gcr_resource_type",
#@   "slack_resource_type")


#! Do nothing for now!
#@ def slack_failure_notification():
#@ return None
#@ end


#@ def nodejs_check_code():
name: check-code
serial: true
plan:
- in_parallel:
  - { get: repo, trigger: true }
  - { get: pipeline-tasks }
  - { get: bundled-deps, trigger: true}
- task: check-code
  config:
    platform: linux
    image_resource: #@ nodejs_task_image_config()
    inputs:
    - name: bundled-deps
    - name: pipeline-tasks
    - name: repo
    run:
      path: pipeline-tasks/ci/tasks/nodejs-check-code.sh #! that's the change
on_failure: #@ slack_failure_notification()
#@ end

#! copy from pipeline-fragments.lib.yml
#@ def install_pnpm_deps():
name: install-deps
plan:
- in_parallel:
  - {get: deps, trigger: true}
  - {get: pipeline-tasks}
  - {put: deps-version, params: {bump: patch}}
- task: install-deps
  config:
    platform: linux
    image_resource: #@ nodejs_task_image_config()
    inputs:
    - name: pipeline-tasks
    - name: deps
    - name: deps-version
    outputs:
    - name: bundled-deps
    run:
      path: pipeline-tasks/ci/vendor/tasks/cache-pnpm-deps.sh #! that's the change
- put: bundled-deps
  params:
    file: bundled-deps/bundled-deps-*.tgz
on_failure: #@ slack_failure_notification()
#@ end

#! This is copied from galoy-client and it's a hot candidate to move into 
#@ def test():
name: test
serial: true
plan:
- in_parallel:
  - { get: repo, trigger: true }
  - { get: bundled-deps, trigger: true }
  - { get: pipeline-tasks }
- task: test
  config:
    platform: linux
    image_resource: #@ nodejs_task_image_config()
    inputs:
    - name: bundled-deps
    - name: pipeline-tasks
    - name: repo
    run:
      path: pipeline-tasks/ci/tasks/test.sh
#@ end

#@ def build():
name: build
serial: true
plan:
- in_parallel:
  - { get: repo, trigger: true }
  - { get: bundled-deps, trigger: true }
  - { get: pipeline-tasks }
- task: build
  config:
    platform: linux
    image_resource: #@ nodejs_task_image_config()
    inputs:
    - name: bundled-deps
    - name: pipeline-tasks
    - name: repo
    outputs:
    - name: repo
    run:
      path: pipeline-tasks/ci/tasks/build.sh
#@ end



jobs:
- #@ nodejs_check_code()
- #@ nodejs_audit()
- #@ install_pnpm_deps()
- #@ test()
- #@ build()



resources:
- #@ repo_resource()
- #@ nodejs_deps_resource( pckgMgr="pnpm")
- #@ pipeline_tasks_resource()
- #@ deps_version_resource()
- #@ bundled_deps_resource()
- #@ slack_resource()

resource_types:
- #@ gcr_resource_type()
- #@ slack_resource_type()
